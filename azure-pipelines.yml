trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  DECK_IMAGE: 'hbagdi/deck:v1.34.0'

steps:
# SÃ³ pra depurar se precisar
- script: |
    echo "Listing files:"
    ls -la
  displayName: Repo files

# 1) Validar kong.yml com decK (lint/schema)
- script: |
    docker run --rm -v $(System.DefaultWorkingDirectory):/w -w /w $(DECK_IMAGE) \
      validate --files kong.yml
  displayName: Validate kong.yml (decK)

# 2) Subir docker-compose (Kong + Swagger) e health-check do portal
- script: |
    docker compose up -d
    echo "Waiting containers..."
    sleep 10
    echo "Containers:"
    docker ps
    echo "Checking Swagger portal (container direto)..."
    curl -sSf http://localhost:8091 > /dev/null
    echo "Checking Swagger via Kong /docs..."
    curl -sSf http://localhost:8080/docs > /dev/null
  displayName: Smoke test (docker compose up + /docs)
