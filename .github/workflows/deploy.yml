name: Deploy Gateway API

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy Gateway API
    runs-on: self-hosted

    steps:
      # ---------------------------------------------------
      # 1Ô∏è‚É£ Checkout do c√≥digo
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2Ô∏è‚É£ Validar Docker (igual aos outros que funcionam)
      # ---------------------------------------------------
      - name: Validate Docker
        shell: powershell
        run: |
          docker info

      # ---------------------------------------------------
      # 3Ô∏è‚É£ Build da imagem (DENTRO da pasta Gateway.Api)
      #    üî¥ N√ÉO mexe no Dockerfile
      # ---------------------------------------------------
      - name: Build Docker image
        shell: powershell
        run: |
          cd Gateway.Api
          docker build -t gateway-api:latest .

      # ---------------------------------------------------
      # 4Ô∏è‚É£ Deploy no Kubernetes
      #    üî¥ SEM proxy, SEM valida√ß√£o OpenAPI
      # ---------------------------------------------------
      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          $env:HTTP_PROXY=""
          $env:HTTPS_PROXY=""
          $env:NO_PROXY="localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,kubernetes.docker.internal"

          kubectl apply -f k8s/ -n fiap-cloud-games --validate=false
          kubectl rollout restart deployment gateway-api -n fiap-cloud-games
          kubectl rollout status deployment gateway-api -n fiap-cloud-games

      # ---------------------------------------------------
      # 5Ô∏è‚É£ Verifica√ß√£o final
      # ---------------------------------------------------
      - name: Verify deployment
        shell: powershell
        run: |
          kubectl get pods -n fiap-cloud-games
          kubectl get svc  -n fiap-cloud-games
