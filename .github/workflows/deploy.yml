name: Deploy Gateway API

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy Gateway API
    runs-on: self-hosted

    steps:
      # ---------------------------------------------------
      # 1️⃣ Checkout
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2️⃣ Validar Docker
      # ---------------------------------------------------
      - name: Validate Docker
        shell: powershell
        run: |
          docker info

      # ---------------------------------------------------
      # 3️⃣ Configurar KUBECONFIG (IGUAL INFRA-K8S)
      # ---------------------------------------------------
      - name: Configure kubeconfig
        shell: powershell
        run: |
          $source = "C:\Users\Matheus\.kube\config"
          $targetDir = "C:\actions-runner\_kube"
          $target = "$targetDir\config"

          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          Copy-Item $source $target -Force

          "KUBECONFIG=$target" | Out-File -FilePath $env:GITHUB_ENV -Append

      # ---------------------------------------------------
      # 4️⃣ Build Docker (DENTRO da pasta Gateway.Api)
      # ---------------------------------------------------
      - name: Build Docker image
        shell: powershell
        run: |
          cd Gateway.Api
          docker build -t gateway-api:latest .

      # ---------------------------------------------------
      # 5️⃣ Deploy Kubernetes (SEM OPENAPI / SEM PROXY)
      # ---------------------------------------------------
      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          kubectl apply -f k8s/ -n fiap-cloud-games --validate=false
          kubectl rollout restart deployment gateway-api -n fiap-cloud-games
          kubectl rollout status deployment gateway-api -n fiap-cloud-games

      # ---------------------------------------------------
      # 6️⃣ Verificação final
      # ---------------------------------------------------
      - name: Verify deployment
        shell: powershell
        run: |
          kubectl get pods -n fiap-cloud-games
          kubectl get svc  -n fiap-cloud-games
